<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FNDTN">
    <meta name="description" content="Complete performance tracking: recovery, supplements, workouts, and monthly challenges">
    <meta name="theme-color" content="#2C5AA0">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>FNDTN Performance Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0A0A0A;
            color: #FFFFFF;
            overflow-x: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #2C5AA0 0%, #4A7C59 100%);
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header .subtitle {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .recovery-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            margin-top: 8px;
        }

        .recovery-green { background: #4A7C59; color: white; }
        .recovery-amber { background: #FF9500; color: white; }
        .recovery-red { background: #FF3B30; color: white; }

        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1A1A1A;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .tab-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background: none;
            border: none;
            color: #7D7D7D;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-button.active {
            color: #2C5AA0;
        }

        .tab-icon {
            font-size: 24px;
        }

        .tab-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .content {
            padding: 20px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .card {
            background: #1A1A1A;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #3A3A3A;
            max-width: 100%;
            box-sizing: border-box;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #3A3A3A;
        }

        .card-icon {
            font-size: 24px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
        }

        .card-subtitle {
            font-size: 14px;
            color: #7D7D7D;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #7D7D7D;
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            background: #2A2A2A;
            border: 1px solid #3A3A3A;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 16px;
        }

        .input-field:focus {
            outline: none;
            border-color: #2C5AA0;
        }

        .button-primary {
            width: 100%;
            background: linear-gradient(135deg, #2C5AA0 0%, #4A7C59 100%);
            border: none;
            border-radius: 8px;
            padding: 16px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .button-primary:active {
            transform: scale(0.98);
        }

        .supplement-item {
            background: #2A2A2A;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
        }

        .supplement-item.completed {
            background: #1a3d2a;
            border: 1px solid #4A7C59;
        }

        .supplement-info {
            flex: 1;
        }

        .supplement-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .supplement-dose {
            font-size: 13px;
            color: #7D7D7D;
        }

        .check-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #3A3A3A;
            background: #1A1A1A;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .check-button.checked {
            background: #4A7C59;
            border-color: #4A7C59;
        }

        .check-icon {
            color: white;
            font-size: 20px;
            display: none;
        }

        .check-button.checked .check-icon {
            display: block;
        }

        .progress-ring {
            text-align: center;
            margin: 20px 0;
        }

        .progress-value {
            font-size: 48px;
            font-weight: 700;
            color: #2C5AA0;
        }

        .progress-label {
            font-size: 14px;
            color: #7D7D7D;
            margin-top: 8px;
        }

        .time-badge {
            display: inline-block;
            background: #2C5AA0;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: auto;
        }

        .exercise-row {
            background: #2A2A2A;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .exercise-name {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .exercise-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            width: 100%;
        }

        .exercise-input {
            background: #1A1A1A;
            border: 1px solid #3A3A3A;
            border-radius: 6px;
            padding: 8px;
            color: white;
            font-size: 14px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }

        .exercise-input:focus {
            outline: none;
            border-color: #2C5AA0;
        }

        .advisory-board {
            display: grid;
            gap: 16px;
        }

        .advisor-card {
            background: #2A2A2A;
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid #2C5AA0;
        }

        .advisor-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .advisor-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2C5AA0 0%, #4A7C59 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .advisor-info h3 {
            font-size: 16px;
            font-weight: 700;
        }

        .advisor-info p {
            font-size: 12px;
            color: #7D7D7D;
        }

        .advisor-advice {
            font-size: 14px;
            line-height: 1.6;
            color: #CCCCCC;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .stat-card {
            background: #2A2A2A;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2C5AA0;
        }

        .stat-label {
            font-size: 12px;
            color: #7D7D7D;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .warning-banner {
            background: #FF9500;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 600;
        }

        .success-banner {
            background: #4A7C59;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 600;
        }

        .workout-image-container {
            margin-bottom: 20px;
            border-radius: 12px;
            position: relative;
            width: 100%;
            min-height: 200px;
            background: #2A2A2A;
        }

        .workout-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 12px;
        }

        .image-overlay {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .overlay-button {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .overlay-button:active {
            transform: scale(0.95);
        }

        .upload-button {
            width: 100%;
            background: #2A2A2A;
            border: 2px dashed #3A3A3A;
            border-radius: 8px;
            padding: 24px;
            color: #7D7D7D;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .upload-button:hover {
            border-color: #2C5AA0;
            color: #2C5AA0;
        }

        .upload-icon {
            font-size: 32px;
        }

        .file-input {
            display: none;
        }

        .challenge-section {
            background: #2A2A2A;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .challenge-title {
            font-size: 16px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .challenge-subtitle {
            font-size: 13px;
            color: #7D7D7D;
            margin-bottom: 16px;
        }

        .pushup-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            width: 100%;
        }

        .pushup-set {
            aspect-ratio: 1;
            background: #1A1A1A;
            border: 2px solid #3A3A3A;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 0;
        }

        .pushup-set.completed {
            background: #1a3d2a;
            border-color: #4A7C59;
        }

        .pushup-set .set-number {
            font-size: 11px;
            color: #7D7D7D;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .pushup-set .set-count {
            font-size: 16px;
            font-weight: 700;
            color: #FFFFFF;
        }

        .pushup-set.completed .set-count {
            color: #4A7C59;
        }

        .pullup-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            width: 100%;
        }

        .pullup-set {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .pullup-label {
            font-size: 11px;
            color: #7D7D7D;
            font-weight: 600;
            text-align: center;
        }

        .pullup-input {
            background: #1A1A1A;
            border: 2px solid #3A3A3A;
            border-radius: 8px;
            padding: 12px 4px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }

        .pullup-input:focus {
            outline: none;
            border-color: #2C5AA0;
        }

        .challenge-progress {
            background: #1A1A1A;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .progress-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #3A3A3A;
        }

        .progress-row:last-child {
            border-bottom: none;
        }

        .progress-label {
            font-size: 13px;
            color: #7D7D7D;
        }

        .progress-value {
            font-size: 18px;
            font-weight: 700;
        }

        .progress-value.complete {
            color: #4A7C59;
        }

        .progress-value.incomplete {
            color: #FF9500;
        }

        .month-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Supplement schedule data
        const supplementSchedule = [
            {
                time: "5:30 AM",
                title: "Morning Start",
                icon: "ðŸŒ…",
                supplements: [
                    { name: "AG1", dose: "1 scoop", reason: "B-vitamins, probiotics, greens" }
                ]
            },
            {
                time: "6:00 AM",
                title: "Pre-Workout",
                icon: "ðŸ’ª",
                supplements: [
                    { name: "L-Citrulline", dose: "6g" },
                    { name: "Creatine", dose: "5g" },
                    { name: "L-Theanine", dose: "100mg" }
                ]
            },
            {
                time: "7:00 AM",
                title: "Post-Workout",
                icon: "ðŸ‹ï¸",
                supplements: [
                    { name: "Protein", dose: "25-30g" },
                    { name: "Creatine", dose: "5g" },
                    { name: "Vitamin C", dose: "500mg" }
                ]
            },
            {
                time: "10:00 AM",
                title: "Breakfast",
                icon: "ðŸ¥£",
                supplements: [
                    { name: "Astaxanthin", dose: "8-12mg" },
                    { name: "NAD+", dose: "250mg" },
                    { name: "CoQ10", dose: "200mg" },
                    { name: "Berberine", dose: "500mg" },
                    { name: "Vitamin D3", dose: "4000 IU" },
                    { name: "Vitamin K2", dose: "200mcg" },
                    { name: "Omega-3", dose: "2-3g" },
                    { name: "Ashwagandha", dose: "300mg" },
                    { name: "B-Complex", dose: "1 cap" },
                    { name: "Plant Sterols", dose: "2g" },
                    { name: "Selenium", dose: "200mcg" }
                ]
            },
            {
                time: "1:00 PM",
                title: "Lunch",
                icon: "ðŸ¥—",
                supplements: [
                    { name: "Berberine", dose: "500mg" },
                    { name: "Vitamin C", dose: "500mg" }
                ]
            },
            {
                time: "6:00 PM",
                title: "Dinner",
                icon: "ðŸ½ï¸",
                supplements: [
                    { name: "Berberine", dose: "500mg" },
                    { name: "Red Yeast Rice", dose: "1200mg" },
                    { name: "Vitamin A", dose: "3000 IU" }
                ]
            },
            {
                time: "8:30 PM",
                title: "Before Bed",
                icon: "ðŸŒ™",
                supplements: [
                    { name: "Ashwagandha", dose: "300mg" },
                    { name: "L-Theanine", dose: "200mg" },
                    { name: "Magnesium", dose: "400-600mg" }
                ]
            }
        ];

        // Weekly workout program
        const workoutProgram = {
            Monday: {
                name: "PERFORM",
                type: "Cardio",
                exercises: [
                    { name: "Rowing Intervals", target: "5x500m" },
                    { name: "Bike Sprints", target: "8x30sec" },
                    { name: "Battle Ropes", target: "4x45sec" }
                ]
            },
            Tuesday: {
                name: "BUILD - Lower",
                type: "Strength",
                exercises: [
                    { name: "Squats", target: "4x8" },
                    { name: "Romanian Deadlifts", target: "4x10" },
                    { name: "Leg Press", target: "3x12" },
                    { name: "Calf Raises", target: "3x15" }
                ]
            },
            Wednesday: {
                name: "ADAPT",
                type: "Mobility",
                exercises: [
                    { name: "Yoga Flow", target: "45min" },
                    { name: "Mobility Drills", target: "20min" }
                ]
            },
            Thursday: {
                name: "POWER",
                type: "Power",
                exercises: [
                    { name: "Power Cleans", target: "5x3" },
                    { name: "Box Jumps", target: "4x8" },
                    { name: "Med Ball Slams", target: "4x10" }
                ]
            },
            Friday: {
                name: "BUILD - Upper",
                type: "Strength",
                exercises: [
                    { name: "Bench Press", target: "4x8" },
                    { name: "Pull-ups", target: "4x8" },
                    { name: "Shoulder Press", target: "3x10" },
                    { name: "Rows", target: "3x12" }
                ]
            },
            Saturday: {
                name: "Community",
                type: "Group",
                exercises: [
                    { name: "Group Class", target: "60min" }
                ]
            },
            Sunday: {
                name: "Yoga",
                type: "Recovery",
                exercises: [
                    { name: "Restorative Yoga", target: "60min" }
                ]
            }
        };

        function App() {
            const [activeTab, setActiveTab] = useState('recovery');
            const [recoveryData, setRecoveryData] = useState({
                sleepPerformance: '',
                hrv: '',
                sleepDebt: '',
                sleepDuration: ''
            });
            const [recoveryScore, setRecoveryScore] = useState(null);
            const [supplementState, setSupplementState] = useState({});
            const [workoutData, setWorkoutData] = useState({});
            const [savedMessage, setSavedMessage] = useState('');
            const [workoutImage, setWorkoutImage] = useState(null);
            const [customWorkout, setCustomWorkout] = useState(null);
            const [challengeData, setChallengeData] = useState({
                pushupSets: [false, false, false, false, false],
                pullupSets: ['', '', '', '']
            });
            const [challengeSaved, setChallengeSaved] = useState(false);
            const [ocrProcessing, setOcrProcessing] = useState(false);
            const [ocrText, setOcrText] = useState('');
            const [apiKey, setApiKey] = useState(localStorage.getItem('google-vision-api-key') || '');
            const [claudeApiKey, setClaudeApiKey] = useState(localStorage.getItem('anthropic-api-key') || '');
            const [advisors, setAdvisors] = useState([]);
            const [loadingAdvisors, setLoadingAdvisors] = useState(false);
            const [mealPhoto, setMealPhoto] = useState(null);
            const [mealAnalyzing, setMealAnalyzing] = useState(false);
            const [currentMeal, setCurrentMeal] = useState(null);
            const [menuPhoto, setMenuPhoto] = useState(null);
            const [mealAnalysing, setMealAnalysing] = useState(false);
            const [menuAnalysing, setMenuAnalysing] = useState(false);
            const [menuRecommendation, setMenuRecommendation] = useState(null);
            const [menuRecommendation, setMenuRecommendation] = useState(null);
            const [menuAnalyzing, setMenuAnalyzing] = useState(false);
            const [imageLoading, setImageLoading] = useState(false);

            // Load state from localStorage
            useEffect(() => {
                const stored = localStorage.getItem('fndtn-tracker-state');
                if (stored) {
                    const state = JSON.parse(stored);
                    const today = new Date().toDateString();
                    if (state.date === today) {
                        setSupplementState(state.supplements || {});
                        setRecoveryScore(state.recoveryScore);
                        setRecoveryData(state.recoveryData || {});
                        // workoutImage not loaded from localStorage (too large)
                        setCustomWorkout(state.customWorkout || null);
                        setChallengeData(state.challengeData || {
                            pushupSets: [false, false, false, false, false],
                            pullupSets: ['', '', '', '']
                        });
                    }
                }
                
                // Load monthly challenge history
                const challenges = localStorage.getItem('fndtn-monthly-challenges');
                if (challenges) {
                    const history = JSON.parse(challenges);
                    const today = new Date().toDateString();
                    const todayChallenge = history.find(c => c.date === today);
                    if (todayChallenge) {
                        setChallengeSaved(true);
                    }
                }
            }, []);

            // Save state to localStorage
            useEffect(() => {
                const state = {
                    date: new Date().toDateString(),
                    supplements: supplementState,
                    recoveryScore,
                    recoveryData,
                    // Don't save workoutImage - too large for localStorage
                    customWorkout,
                    challengeData
                };
                localStorage.setItem('fndtn-tracker-state', JSON.stringify(state));
            }, [supplementState, recoveryScore, recoveryData, customWorkout, challengeData]);

            // Load AI advisory board when recovery score changes
            useEffect(() => {
                if (recoveryScore !== null) {
                    if (claudeApiKey) {
                        setLoadingAdvisors(true);
                        getAIAdvisoryBoard(recoveryScore).then(result => {
                            setAdvisors(result);
                            setLoadingAdvisors(false);
                        });
                    } else {
                        setAdvisors(getAdvisoryBoard(recoveryScore));
                    }
                }
            }, [recoveryScore, claudeApiKey]);

            const calculateRecovery = () => {
                const sleep = parseFloat(recoveryData.sleepPerformance);
                const hrv = parseFloat(recoveryData.hrv);
                const debt = parseFloat(recoveryData.sleepDebt);
                
                if (!sleep || !hrv || debt === '') return null;

                // Personal formula with 65% accuracy
                let score = (sleep * 0.40) + ((hrv / 70) * 48) - (debt * 0.12);
                
                // Day of week adjustment
                const day = new Date().getDay();
                if (day === 0) score += 4; // Sunday
                if (day === 6) score += 3; // Saturday
                if (day >= 3 && day <= 5) score -= 2; // Wed-Fri

                return Math.max(0, Math.min(100, Math.round(score)));
            };

            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    console.log('File selected:', file.name, file.size);
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        console.log('Setting image...');
                        setWorkoutImage(e.target.result);
                        setCustomWorkout(null);
                        console.log('Image set!');
                    };
                    reader.onerror = (error) => {
                        console.error('Error:', error);
                        alert('Error loading image');
                    };
                    reader.readAsDataURL(file);
                }
            };

            const clearWorkoutImage = () => {
                setWorkoutImage(null);
                setCustomWorkout(null);
            };

            const parseWorkoutText = (text) => {
                // Split by lines and filter out empty lines
                const lines = text.split('\n').filter(line => line.trim());
                
                // Group exercises by blocks (look for EMOM time and station count)
                let currentBlockTime = null;
                let currentBlockStations = null;
                let currentBlockExercises = [];
                const blocks = [];
                
                lines.forEach(line => {
                    // Check if line contains EMOM time info with station count
                    // Format: "BLOCK 1 - 12MIN EMOM - 3 stations"
                    const emomWithStationsMatch = line.match(/(\d+)\s*MIN\s*EMOM\s*-\s*(\d+)\s*stations/i);
                    const emomMatch = line.match(/(\d+)-(\d+)\s*MIN\s*EMOM/i) || line.match(/(\d+)\s*MIN\s*EMOM/i);
                    
                    if (emomWithStationsMatch) {
                        // Save previous block if exists
                        if (currentBlockExercises.length > 0) {
                            blocks.push({
                                time: currentBlockTime,
                                stations: currentBlockStations,
                                exercises: currentBlockExercises
                            });
                        }
                        // New block with explicit station count
                        currentBlockTime = parseInt(emomWithStationsMatch[1]);
                        currentBlockStations = parseInt(emomWithStationsMatch[2]);
                        currentBlockExercises = [];
                    } else if (emomMatch) {
                        // Save previous block if exists
                        if (currentBlockExercises.length > 0) {
                            blocks.push({
                                time: currentBlockTime,
                                stations: currentBlockStations,
                                exercises: currentBlockExercises
                            });
                        }
                        // Start new block - use maximum time, no station count yet
                        currentBlockTime = emomMatch[2] ? parseInt(emomMatch[2]) : parseInt(emomMatch[1]);
                        currentBlockStations = null;
                        currentBlockExercises = [];
                    } else if (line.includes('-') && !line.match(/BLOCK|MIN|stations/i)) {
                        // This looks like an exercise line
                        const parts = line.split(/[-â€“]/);
                        currentBlockExercises.push({
                            name: parts[0].trim(),
                            target: parts[1]?.trim() || '',
                            blockTime: currentBlockTime,
                            blockStations: currentBlockStations
                        });
                    }
                });
                
                // Add last block
                if (currentBlockExercises.length > 0) {
                    blocks.push({
                        time: currentBlockTime,
                        stations: currentBlockStations,
                        exercises: currentBlockExercises
                    });
                }
                
                // Flatten blocks and calculate rounds per exercise
                const allExercises = [];
                blocks.forEach(block => {
                    block.exercises.forEach(ex => {
                        if (block.time && (block.stations || block.exercises.length > 0)) {
                            // EMOM: rounds = time Ã· total stations (including rest)
                            const totalStations = block.stations || block.exercises.length;
                            const rounds = Math.floor(block.time / totalStations);
                            allExercises.push({
                                ...ex,
                                target: `${rounds}x${ex.target}`,
                                rounds: rounds
                            });
                        } else {
                            allExercises.push(ex);
                        }
                    });
                });
                
                return allExercises.length > 0 ? allExercises : lines.map(line => {
                    const parts = line.split(/[-â€“]/);
                    return {
                        name: parts[0].trim(),
                        target: parts[1]?.trim() || ''
                    };
                });
            };

            const handleWorkoutTextChange = (text) => {
                if (text.trim()) {
                    const exercises = parseWorkoutText(text);
                    if (exercises.length > 0) {
                        setCustomWorkout({
                            name: "Custom Workout",
                            type: "Custom",
                            exercises: exercises
                        });
                    }
                } else {
                    setCustomWorkout(null);
                }
            };

            const saveApiKey = (key) => {
                localStorage.setItem('google-vision-api-key', key);
                setApiKey(key);
            };

            const saveClaudeApiKey = (key) => {
                const trimmedKey = key.trim();
                
                // Validate format
                if (trimmedKey && !trimmedKey.startsWith('sk-ant-')) {
                    alert('âš ï¸ API key should start with "sk-ant-"\n\nPlease check you copied the full key from console.anthropic.com');
                    return;
                }
                
                localStorage.setItem('anthropic-api-key', trimmedKey);
                setClaudeApiKey(trimmedKey);
                
                if (trimmedKey) {
                    alert('âœ“ Claude API key saved!\n\nNext time you upload a workout image and tap "Read Text", Claude will parse it intelligently.');
                }
            };

            const parseWorkoutWithClaude = async (ocrText) => {
                if (!claudeApiKey) {
                    console.log('No Claude API key - using simple parsing');
                    return parseWorkoutText(ocrText);
                }

                console.log('ðŸ¤– Sending to Claude API via Cloudflare Worker...');

                try {
                    const requestBody = {
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        messages: [{
                            role: 'user',
                            content: `You are parsing a workout board image text. Extract exercises grouped by their blocks with EMOM timing preserved.

CRITICAL: For EMOM blocks, count ALL stations (including Rest) to determine the cycle, but only list actual exercises.

Rules:
1. Count total stations per EMOM block (exercises + rest periods) for cycle calculation
2. Format: "BLOCK X - [TIME]MIN EMOM - [TOTAL_STATIONS] stations"
3. Then list ONLY actual exercises (exclude Rest)
4. Format exercises as "Exercise Name - Reps"
5. For rep ranges like "10-12", keep as "10-12"
6. For "e/s" (each side), include it: "10-12 e/s"

Example:

Input: 
"BLOCK 1 - 9-12MIN EMOM
A. Trap Bar Deadlift x 10-12
B. DB Split Squat x 5-8 e/s
C. Rest x 60 SECONDS"

Output:
BLOCK 1 - 12MIN EMOM - 3 stations
Trap Bar Deadlift - x10-12
DB Bulgarian Split Squat - x5-8 e/s

Explanation: 12 minutes with 3 stations (2 exercises + 1 rest) = 4 rounds of each exercise
But we only list the 2 actual exercises, not the rest period.

Now parse this workout:
${ocrText}`
                        }]
                    };

                    // Use Cloudflare Worker proxy
                    const response = await fetch('https://anthropic-proxy.peter-5aa.workers.dev/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': claudeApiKey
                        },
                        body: JSON.stringify(requestBody)
                    });

                    console.log('Worker response status:', response.status);

                    const data = await response.json();
                    console.log('Claude API response:', JSON.stringify(data, null, 2));
                    
                    if (!response.ok) {
                        console.error('API request failed:', data);
                        let errorMsg = 'Claude API Error: ';
                        
                        if (data.error) {
                            if (data.error.type === 'authentication_error') {
                                errorMsg += 'Invalid API key. Check your Anthropic API key.';
                            } else if (data.error.type === 'permission_error') {
                                errorMsg += 'API key lacks permissions. Check your API key settings.';
                            } else if (data.error.type === 'rate_limit_error') {
                                errorMsg += 'Rate limit exceeded. Try again in a moment.';
                            } else {
                                errorMsg += data.error.message || 'Unknown error';
                            }
                        } else {
                            errorMsg += `HTTP ${response.status}`;
                        }
                        
                        alert(errorMsg + '\n\nFalling back to simple parsing.');
                        return parseWorkoutText(ocrText);
                    }
                    
                    if (data.content && data.content[0] && data.content[0].text) {
                        const parsedText = data.content[0].text.trim();
                        console.log('âœ“ Claude parsed text:', parsedText);
                        return parseWorkoutText(parsedText);
                    } else {
                        console.error('Unexpected response format:', data);
                        alert('Unexpected response from Claude API. Using simple parsing.');
                        return parseWorkoutText(ocrText);
                    }
                } catch (error) {
                    console.error('Claude API Error:', error);
                    console.error('Error details:', error.message, error.stack);
                    alert(`Error calling Claude API: ${error.message}\n\nFalling back to simple parsing.`);
                    return parseWorkoutText(ocrText);
                }
            };

            const processImageWithOCR = async (imageData) => {
                if (!apiKey) {
                    alert('Please enter your Google Cloud Vision API key first');
                    return;
                }

                setOcrProcessing(true);
                setOcrText('');

                try {
                    // Step 1: Extract text with Google Vision
                    const base64Image = imageData.split(',')[1];

                    const response = await fetch(
                        `https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                requests: [
                                    {
                                        image: {
                                            content: base64Image
                                        },
                                        features: [
                                            {
                                                type: 'TEXT_DETECTION',
                                                maxResults: 1
                                            }
                                        ]
                                    }
                                ]
                            })
                        }
                    );

                    const data = await response.json();
                    
                    if (data.responses && data.responses[0].textAnnotations) {
                        const extractedText = data.responses[0].textAnnotations[0].description;
                        setOcrText(extractedText);
                        
                        // Step 2: Parse with Claude if API key available
                        if (claudeApiKey) {
                            const exercises = await parseWorkoutWithClaude(extractedText);
                            if (exercises.length > 0) {
                                setCustomWorkout({
                                    name: "Custom Workout",
                                    type: "Custom",
                                    exercises: exercises
                                });
                            }
                        } else {
                            // Use simple parsing
                            handleWorkoutTextChange(extractedText);
                        }
                    } else if (data.error) {
                        alert(`API Error: ${data.error.message}`);
                    } else {
                        alert('No text found in image');
                    }
                } catch (error) {
                    console.error('OCR Error:', error);
                    alert('Error processing image. Check your API key and internet connection.');
                } finally {
                    setOcrProcessing(false);
                }
            };

            const togglePushupSet = (index) => {
                const newSets = [...challengeData.pushupSets];
                newSets[index] = !newSets[index];
                setChallengeData({...challengeData, pushupSets: newSets});
            };

            const updatePullupSet = (index, value) => {
                const newSets = [...challengeData.pullupSets];
                newSets[index] = value;
                setChallengeData({...challengeData, pullupSets: newSets});
            };

            const calculatePullupTotal = () => {
                return challengeData.pullupSets.reduce((sum, val) => sum + (parseInt(val) || 0), 0);
            };

            const saveChallenge = () => {
                const challenges = JSON.parse(localStorage.getItem('fndtn-monthly-challenges') || '[]');
                const today = new Date().toDateString();
                const monthYear = new Date().toLocaleDateString('en-AU', { month: 'long', year: 'numeric' });
                
                const pushupTotal = challengeData.pushupSets.filter(s => s).length * 20;
                const pullupTotal = calculatePullupTotal();
                
                // Remove today's entry if exists (update scenario)
                const filteredChallenges = challenges.filter(c => c.date !== today);
                
                filteredChallenges.push({
                    date: today,
                    monthYear,
                    pushups: {
                        sets: challengeData.pushupSets,
                        total: pushupTotal
                    },
                    pullups: {
                        sets: challengeData.pullupSets,
                        total: pullupTotal
                    }
                });
                
                localStorage.setItem('fndtn-monthly-challenges', JSON.stringify(filteredChallenges));
                setChallengeSaved(true);
                setTimeout(() => setChallengeSaved(false), 3000);
            };

            const getChallengeStats = () => {
            const analyseMeal = async (imageData) => {
                if (!apiKey || !claudeApiKey) {
                    alert('Both Google Vision and Claude API keys required for meal analysis');
                    return;
                }

                setMealAnalysing(true);

                try {
                    // Step 1: Extract text from meal photo using Google Vision OCR
                    const base64Image = imageData.split(',')[1];
                    const ocrResponse = await fetch(
                        `https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                requests: [{
                                    image: { content: base64Image },
                                    features: [{ type: 'TEXT_DETECTION' }]
                                }]
                            })
                        }
                    );

                    const ocrData = await ocrResponse.json();
                    let detectedText = '';
                    if (ocrData.responses?.[0]?.textAnnotations) {
                        detectedText = ocrData.responses[0].textAnnotations[0].description;
                    }

                    console.log('OCR detected text:', detectedText);

                    // Step 2: Analyse the OCR text with Claude
                    const claudeResponse = await fetch('https://anthropic-proxy.peter-5aa.workers.dev/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': claudeApiKey
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1500,
                            messages: [{
                                role: 'user',
                                content: `You are analysing a meal based on text extracted from a food photo via OCR (nutrition labels, packaging, menu text).

**Text extracted from image:**
${detectedText || '[No readable text detected in image]'}

**Task:**
Based on the extracted text, estimate the meal's nutritional content for Peter's tracking.

**Peter's Genetic Requirements:**
- IL-6 GG: Elevated inflammation risk (prioritise anti-inflammatory foods)
- LDL-R CT: Saturated fat sensitivity (<7% of calories)
- Diabetes variants: Low glycemic index, controlled carbs
- Fat-sensitive variants: Total fat 25-30%, quality emphasis
- Minimum per meal: 30g protein, 10g fibre

**Current Recovery State:** ${recoveryScore ? recoveryScore + '%' : 'Not calculated'}

**Instructions:**
- If sufficient text was detected, analyse and estimate macros
- If no meaningful text, indicate unable to analyse
- Return ONLY valid JSON in code fences
- No explanatory text before or after JSON

\`\`\`json
{
  "mealName": "Brief description from detected text",
  "estimatedMacros": {
    "protein": "30-35g",
    "carbs": "40-50g",
    "fat": "15-20g"
  },
  "geneticAlignment": "How this meal aligns with IL-6, LDL-R, diabetes requirements",
  "recoveryOptimisation": "Relevance to current recovery state",
  "improvements": "Suggestions if applicable"
}
\`\`\``
                            }]
                        })
                    });

                    const claudeData = await claudeResponse.json();
                    console.log('Claude response:', claudeData);
                    
                    if (claudeData.content?.[0]?.text) {
                        const responseText = claudeData.content[0].text;
                        console.log('Response text:', responseText);
                        
                        // Extract JSON from response
                        const jsonMatch = responseText.match(/```json\n?([\s\S]*?)\n?```/) || 
                                        responseText.match(/\{[\s\S]*\}/);
                        
                        if (jsonMatch) {
                            const jsonText = jsonMatch[1] || jsonMatch[0];
                            const mealData = JSON.parse(jsonText);
                            
                            console.log('âœ“ Meal data parsed:', mealData);
                            setCurrentMeal(mealData);
                            
                            // Save to history
                            const meals = JSON.parse(localStorage.getItem('fndtn-meals') || '[]');
                            meals.push({
                                date: new Date().toISOString(),
                                ...mealData,
                                recoveryScore
                            });
                            localStorage.setItem('fndtn-meals', JSON.stringify(meals));
                        } else {
                            console.error('No JSON in response');
                            alert('Could not parse meal analysis. Check console.');
                        }
                    }
                } catch (error) {
                    console.error('Meal analysis error:', error);
                    alert('Error: ' + error.message);
                } finally {
                    setMealAnalysing(false);
                }
            };

            const analyseMenu = async (imageData) => {
                if (!apiKey || !claudeApiKey) {
                    alert('Both Google Vision and Claude API keys required');
                    return;
                }

                setMenuAnalysing(true);

                try {
                    // Step 1: Extract menu text via OCR
                    const base64Image = imageData.split(',')[1];
                    const ocrResponse = await fetch(
                        `https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                requests: [{
                                    image: { content: base64Image },
                                    features: [{ type: 'TEXT_DETECTION' }]
                                }]
                            })
                        }
                    );

                    const ocrData = await ocrResponse.json();
                    const menuText = ocrData.responses?.[0]?.textAnnotations?.[0]?.description || '';

                    console.log('Menu OCR text:', menuText);

                    // Step 2: Get Claude's recommendation based on menu TEXT
                    const claudeResponse = await fetch('https://anthropic-proxy.peter-5aa.workers.dev/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': claudeApiKey
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 2000,
                            messages: [{
                                role: 'user',
                                content: `You are Peter's nutrition advisor. Based on text extracted from a restaurant menu via OCR, recommend the best option.

**Menu text extracted:**
${menuText || '[No text detected]'}

**Peter's Genetic Profile:**
- IL-6 GG: Inflammation risk (omega-3, anti-inflammatory priority)
- LDL-R CT: Saturated fat sensitivity (<7%)
- Diabetes variants: Low GI, controlled carbs
- Fat-sensitive: Total fat 25-30%

**Per Meal Targets:** 30g+ protein, 10g+ fibre, <7% saturated fat

**Recovery:** ${recoveryScore ? recoveryScore + '%' : 'Unknown'} ${recoveryScore >= 75 ? '(Training day - higher protein OK)' : recoveryScore >= 60 ? '(Moderate - anti-inflammatory focus)' : '(Rest - lighter, anti-inflammatory)'}

**Instructions:**
Scan the menu text and recommend the BEST dish for Peter's genetics and recovery.
Return ONLY valid JSON in code fences.

\`\`\`json
{
  "recommendedDish": "Exact menu item name from text",
  "reasoning": "Why this is optimal for genetics and recovery",
  "macroEstimate": {
    "protein": "30-35g",
    "carbs": "40g",
    "fat": "20g"
  },
  "geneticBenefits": "Specific benefits for IL-6, LDL-R, diabetes variants",
  "modifications": "What to request (e.g., sauce on side, less oil)",
  "alternatives": "Second choice if first unavailable"
}
\`\`\``
                            }]
                        })
                    });

                    const claudeData = await claudeResponse.json();
                    console.log('Claude menu response:', claudeData);
                    
                    if (claudeData.content?.[0]?.text) {
                        const responseText = claudeData.content[0].text;
                        const jsonMatch = responseText.match(/```json\n?([\s\S]*?)\n?```/) || 
                                        responseText.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const jsonText = jsonMatch[1] || jsonMatch[0];
                            setMenuRecommendation(JSON.parse(jsonText));
                            console.log('âœ“ Menu recommendation generated');
                        } else {
                            alert('Could not parse menu recommendation. Check console.');
                        }
                    }
                } catch (error) {
                    console.error('Menu error:', error);
                    alert('Error: ' + error.message);
                } finally {
                    setMenuAnalysing(false);
                }
            };

                const challenges = JSON.parse(localStorage.getItem('fndtn-monthly-challenges') || '[]');
                const currentMonth = new Date().toLocaleDateString('en-AU', { month: 'long', year: 'numeric' });
                const monthChallenges = challenges.filter(c => c.monthYear === currentMonth);
                
                const totalPushups = monthChallenges.reduce((sum, c) => sum + c.pushups.total, 0);
                const totalPullups = monthChallenges.reduce((sum, c) => sum + c.pullups.total, 0);
                const daysCompleted = monthChallenges.filter(c => 
                    c.pushups.total === 100 && c.pullups.total >= 26
                ).length;
                
                return { totalPushups, totalPullups, daysCompleted, totalDays: monthChallenges.length };
            };

            const getRecoveryStatus = (score) => {
                if (score >= 75) return { status: 'GREEN', color: 'recovery-green', text: 'âœ“ FULL TRAINING CLEARED' };
                if (score >= 60) return { status: 'AMBER', color: 'recovery-amber', text: 'âš ï¸ MODIFIED TRAINING' };
                return { status: 'RED', color: 'recovery-red', text: 'ðŸ›‘ REST REQUIRED' };
            };

            const getAdvisoryBoard = (score) => {
                const advisors = [];
                
                if (score >= 75) {
                    advisors.push({
                        name: "Dr. Andy Galpin",
                        title: "Exercise Physiologist",
                        avatar: "ðŸ‹ï¸",
                        advice: "Excellent recovery state! Full intensity training approved. Your ACE GG variant gives you power advantages - exploit this with compound movements. Target RPE 8-9 today."
                    });
                    advisors.push({
                        name: "Dr. Rhonda Patrick",
                        title: "Nutrition Geneticist",
                        avatar: "ðŸ§¬",
                        advice: "Your IL-6 GG variant means enhanced omega-3 response. Post-workout omega-3 timing is critical today. EVOO with breakfast optimizes fat-soluble vitamin absorption."
                    });
                } else if (score >= 60) {
                    advisors.push({
                        name: "Dr. Andy Galpin",
                        title: "Exercise Physiologist",
                        avatar: "ðŸ‹ï¸",
                        advice: "Moderate recovery. Reduce weights to 70-80% of max. Focus on technique and movement quality. Avoid CNS-intensive lifts. Keep RPE at 6-7 maximum."
                    });
                    advisors.push({
                        name: "Dr. Leah Lagos",
                        title: "HRV Specialist",
                        avatar: "â¤ï¸",
                        advice: "Your HRV indicates system stress. Add 10 minutes of 4-6 breathing today. Focus on parasympathetic activation pre and post-training."
                    });
                } else {
                    advisors.push({
                        name: "Dr. Matthew Walker",
                        title: "Sleep Scientist",
                        avatar: "ðŸ˜´",
                        advice: "Critical sleep debt detected. Training will impair recovery further. Extend tonight's sleep opportunity by 60-90 minutes. Prioritize sleep quality over duration."
                    });
                    advisors.push({
                        name: "Dr. Peter Attia",
                        title: "Longevity Expert",
                        avatar: "ðŸ”¬",
                        advice: "Your metabolic state doesn't support training stress. Light walking only. Consider postponing Thursday's 24-hour fast if recovery doesn't improve by Wednesday."
                    });
                }

                advisors.push({
                    name: "Dr. Leah Lagos",
                    title: "HRV Specialist",
                    avatar: "â¤ï¸",
                    advice: `Current HRV ${recoveryData.hrv}ms. ${recoveryData.hrv < 40 ? 'Below critical threshold - complete rest mandatory.' : recoveryData.hrv > 55 ? 'Optimal - your autonomic system is balanced.' : 'Moderate - focus on stress management today.'}`
                });

                return advisors;
            };

            const getAIAdvisoryBoard = async (score) => {
                if (!claudeApiKey) {
                    return getAdvisoryBoard(score); // Fall back to static
                }

                try {
                    const dayName = new Date().toLocaleDateString('en-AU', { weekday: 'long' });
                    const prompt = `You are the Virtual Advisory Board for Peter Tonagh, providing personalized recovery and performance guidance.

**Today's Biomarkers:**
- Recovery Score: ${score}%
- Sleep Performance: ${recoveryData.sleepPerformance}%
- Sleep Duration: ${recoveryData.sleepDuration} hours
- Sleep Debt: ${recoveryData.sleepDebt} minutes
- HRV: ${recoveryData.hrv}ms
- Day: ${dayName}

**Peter's Genetic Profile:**
- ACE GG (power/strength advantage)
- IL-6 GG (elevated inflammation risk - requires omega-3 emphasis)
- eNOS3 TT (benefits from L-Citrulline pre-workout)
- APOE E3/E3 (enhanced fasting response)
- Multiple diabetes risk variants (TCF7L2, WFS1, SLC30A8)
- LDL-R CT (saturated fat sensitivity)
- CYP24A1 AA (requires higher vitamin D)

**Weekly Training Architecture:**
Monday: PERFORM (cardio), Tuesday: BUILD Lower, Wednesday: ADAPT (mobility), Thursday: POWER, Friday: BUILD Upper, Saturday: Community, Sunday: Yoga

**Recovery Thresholds:**
- GREEN (â‰¥75%): Full intensity training cleared
- AMBER (60-74%): Reduce to 70-80% capacity
- RED (<60%): Complete rest or 50-60% max

Provide recommendations from these 5 experts in JSON format:

\`\`\`json
[
  {
    "name": "Dr. Andy Galpin",
    "title": "Exercise Physiologist",
    "avatar": "ðŸ‹ï¸",
    "advice": "[Specific training recommendation based on today's metrics and genetic profile]"
  },
  {
    "name": "Dr. Matthew Walker",
    "title": "Sleep Scientist",
    "avatar": "ðŸ˜´",
    "advice": "[Sleep-specific guidance based on debt, performance, duration]"
  },
  {
    "name": "Dr. Rhonda Patrick",
    "title": "Nutrition Geneticist",
    "avatar": "ðŸ§¬",
    "advice": "[Supplement/nutrition timing based on recovery state and genetics]"
  },
  {
    "name": "Dr. Peter Attia",
    "title": "Longevity Expert",
    "avatar": "ðŸ”¬",
    "advice": "[Metabolic health guidance, fasting considerations]"
  },
  {
    "name": "Dr. Leah Lagos",
    "title": "HRV Specialist",
    "avatar": "â¤ï¸",
    "advice": "[HRV-specific protocols and autonomic nervous system guidance]"
  }
]
\`\`\`

Make advice specific, actionable, and personalized to today's exact metrics. Be direct and tactical.`;

                    const response = await fetch('https://anthropic-proxy.peter-5aa.workers.dev/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': claudeApiKey
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 2000,
                            messages: [{
                                role: 'user',
                                content: prompt
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.content && data.content[0] && data.content[0].text) {
                        const responseText = data.content[0].text.trim();
                        // Extract JSON from response (might have markdown code fences)
                        const jsonMatch = responseText.match(/```json\n?([\s\S]*?)\n?```/) || 
                                        responseText.match(/\[[\s\S]*\]/);
                        
                        if (jsonMatch) {
                            const jsonText = jsonMatch[1] || jsonMatch[0];
                            const advisors = JSON.parse(jsonText);
                            return advisors;
                        }
                    }
                    
                    // Fallback to static if parsing fails
                    return getAdvisoryBoard(score);
                } catch (error) {
                    console.error('AI Advisory Board Error:', error);
                    // Fallback to static
                    return getAdvisoryBoard(score);
                }
            };

            const toggleSupplement = (timeIndex, suppIndex) => {
                const key = `${timeIndex}-${suppIndex}`;
                setSupplementState(prev => ({
                    ...prev,
                    [key]: !prev[key]
                }));
            };

            const calculateSupplementProgress = () => {
                const total = supplementSchedule.reduce((sum, block) => sum + block.supplements.length, 0);
                const completed = Object.values(supplementState).filter(v => v).length;
                return Math.round((completed / total) * 100);
            };

            const saveWorkout = () => {
                const workouts = JSON.parse(localStorage.getItem('fndtn-workouts') || '[]');
                const today = new Date().toDateString();
                const dayName = new Date().toLocaleDateString('en-AU', { weekday: 'long' });
                
                workouts.push({
                    date: today,
                    day: dayName,
                    workout: customWorkout || workoutProgram[dayName],
                    data: workoutData,
                    recoveryScore,
                    workoutImage
                });
                
                localStorage.setItem('fndtn-workouts', JSON.stringify(workouts));
                setSavedMessage('Workout saved!');
                setTimeout(() => setSavedMessage(''), 3000);
                setWorkoutData({});
            };

            const renderRecoveryTab = () => {
                return (
                    <div className="content">
                        <div className="card">
                            <div className="card-header">
                                <span className="card-icon">ðŸ“Š</span>
                                <div>
                                    <h2 className="card-title">Daily Biomarkers</h2>
                                    <p className="card-subtitle">Input today's Whoop metrics</p>
                                </div>
                            </div>

                            <div className="input-group">
                                <label className="input-label">Sleep Performance (%)</label>
                                <input
                                    type="number"
                                    className="input-field"
                                    value={recoveryData.sleepPerformance}
                                    onChange={(e) => setRecoveryData({...recoveryData, sleepPerformance: e.target.value})}
                                    placeholder="e.g., 85"
                                />
                            </div>

                            <div className="input-group">
                                <label className="input-label">HRV (ms)</label>
                                <input
                                    type="number"
                                    className="input-field"
                                    value={recoveryData.hrv}
                                    onChange={(e) => setRecoveryData({...recoveryData, hrv: e.target.value})}
                                    placeholder="e.g., 55"
                                />
                            </div>

                            <div className="input-group">
                                <label className="input-label">Sleep Debt (minutes)</label>
                                <input
                                    type="number"
                                    className="input-field"
                                    value={recoveryData.sleepDebt}
                                    onChange={(e) => setRecoveryData({...recoveryData, sleepDebt: e.target.value})}
                                    placeholder="e.g., 30"
                                />
                            </div>

                            <div className="input-group">
                                <label className="input-label">Sleep Duration (hours)</label>
                                <input
                                    type="number"
                                    step="0.5"
                                    className="input-field"
                                    value={recoveryData.sleepDuration}
                                    onChange={(e) => setRecoveryData({...recoveryData, sleepDuration: e.target.value})}
                                    placeholder="e.g., 7.5"
                                />
                            </div>

                            <button 
                                className="button-primary"
                                onClick={() => setRecoveryScore(calculateRecovery())}
                            >
                                Calculate Recovery
                            </button>
                        </div>

                        {recoveryScore !== null && (
                            <>
                                <div className="card">
                                    <div className="progress-ring">
                                        <div className="progress-value">{recoveryScore}%</div>
                                        <div className="progress-label">RECOVERY SCORE</div>
                                    </div>
                                    <div style={{textAlign: 'center', marginTop: '16px'}}>
                                        <span className={`recovery-badge ${getRecoveryStatus(recoveryScore).color}`}>
                                            {getRecoveryStatus(recoveryScore).text}
                                        </span>
                                    </div>

                                    <div className="stat-grid">
                                        <div className="stat-card">
                                            <div className="stat-value">{recoveryData.sleepPerformance}%</div>
                                            <div className="stat-label">Sleep</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-value">{recoveryData.hrv}</div>
                                            <div className="stat-label">HRV (ms)</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-value">{recoveryData.sleepDebt}</div>
                                            <div className="stat-label">Debt (min)</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-value">{recoveryData.sleepDuration}</div>
                                            <div className="stat-label">Duration (hrs)</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="card">
                                    <div className="card-header">
                                        <span className="card-icon">ðŸŽ¯</span>
                                        <div style={{flex: 1}}>
                                            <h2 className="card-title">Virtual Advisory Board</h2>
                                            <p className="card-subtitle">
                                                {claudeApiKey ? 'AI-powered personalized recommendations' : 'Expert recommendations'}
                                            </p>
                                        </div>
                                        {loadingAdvisors && (
                                            <span style={{fontSize: '12px', color: '#7D7D7D'}}>â³</span>
                                        )}
                                    </div>
                                    <div className="advisory-board">
                                        {advisors.map((advisor, idx) => (
                                            <div key={idx} className="advisor-card">
                                                <div className="advisor-header">
                                                    <div className="advisor-avatar">{advisor.avatar}</div>
                                                    <div className="advisor-info">
                                                        <h3>{advisor.name}</h3>
                                                        <p>{advisor.title}</p>
                                                    </div>
                                                </div>
                                                <div className="advisor-advice">{advisor.advice}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                );
            };

            const renderSupplementsTab = () => (
                <div className="content">
                    <div className="progress-ring">
                        <div className="progress-value">{calculateSupplementProgress()}%</div>
                        <div className="progress-label">DAILY PROGRESS</div>
                    </div>

                    {supplementSchedule.map((block, timeIndex) => (
                        <div key={timeIndex} className="card">
                            <div className="card-header">
                                <span className="card-icon">{block.icon}</span>
                                <div style={{flex: 1}}>
                                    <h3 className="card-title">{block.title}</h3>
                                    <p className="card-subtitle">{block.time}</p>
                                </div>
                                <span className="time-badge">{block.time}</span>
                            </div>
                            {block.supplements.map((supp, suppIndex) => {
                                const key = `${timeIndex}-${suppIndex}`;
                                const completed = supplementState[key];
                                return (
                                    <div
                                        key={suppIndex}
                                        className={`supplement-item ${completed ? 'completed' : ''}`}
                                        onClick={() => toggleSupplement(timeIndex, suppIndex)}
                                    >
                                        <div className="supplement-info">
                                            <div className="supplement-name">{supp.name}</div>
                                            <div className="supplement-dose">{supp.dose}</div>
                                        </div>
                                        <button className={`check-button ${completed ? 'checked' : ''}`}>
                                            <span className="check-icon">âœ“</span>
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    ))}
                </div>
            );

            const renderWorkoutTab = () => {
                const dayName = new Date().toLocaleDateString('en-AU', { weekday: 'long' });
                const todayWorkout = customWorkout || workoutProgram[dayName];

                return (
                    <div className="content">
                        {recoveryScore !== null && recoveryScore < 75 && (
                            <div className={recoveryScore < 60 ? 'warning-banner' : 'success-banner'}>
                                {recoveryScore < 60 
                                    ? `âš ï¸ Recovery at ${recoveryScore}% - Reduce intensity to 50-60% or rest`
                                    : `âš ï¸ Recovery at ${recoveryScore}% - Reduce weights to 70-80% capacity`
                                }
                            </div>
                        )}

                        {/* Image Upload Section */}
                        {!workoutImage ? (
                            <div>
                                {/* API Key Management */}
                                <div style={{background: apiKey ? '#2A2A2A' : '#FF9500', padding: '16px', borderRadius: '12px', marginBottom: '16px'}}>
                                    <p style={{fontSize: '14px', fontWeight: 600, marginBottom: '8px', color: apiKey ? '#FFFFFF' : '#000'}}>
                                        ðŸ”‘ {apiKey ? 'Google Vision API Key Configured' : 'Google Vision Setup Required'}
                                    </p>
                                    {!apiKey && (
                                        <p style={{fontSize: '12px', marginBottom: '12px', color: '#000'}}>
                                            Enter your Google Cloud Vision API key for text extraction
                                        </p>
                                    )}
                                    <input
                                        type="text"
                                        placeholder="Paste Google Vision API key here"
                                        defaultValue={apiKey}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            borderRadius: '6px',
                                            border: 'none',
                                            fontSize: '14px',
                                            marginBottom: '8px',
                                            boxSizing: 'border-box',
                                            background: '#FFFFFF',
                                            color: '#000000'
                                        }}
                                        onBlur={(e) => {
                                            if (e.target.value) {
                                                saveApiKey(e.target.value);
                                            }
                                        }}
                                    />
                                    {apiKey && (
                                        <button
                                            onClick={() => {
                                                if (confirm('Clear Google Vision API key?')) {
                                                    localStorage.removeItem('google-vision-api-key');
                                                    setApiKey('');
                                                }
                                            }}
                                            style={{
                                                background: '#FF3B30',
                                                border: 'none',
                                                borderRadius: '6px',
                                                padding: '8px 12px',
                                                color: 'white',
                                                fontSize: '12px',
                                                fontWeight: 600,
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Clear Key
                                        </button>
                                    )}
                                </div>

                                {/* Claude API Key Management */}
                                <div style={{background: claudeApiKey ? '#2A2A2A' : '#4A7C59', padding: '16px', borderRadius: '12px', marginBottom: '20px'}}>
                                    <p style={{fontSize: '14px', fontWeight: 600, marginBottom: '8px', color: '#FFFFFF'}}>
                                        ðŸ¤– {claudeApiKey ? 'Claude API Key Configured' : 'Claude AI Setup (Optional)'}
                                    </p>
                                    {!claudeApiKey && (
                                        <p style={{fontSize: '12px', marginBottom: '12px', color: '#FFFFFF', opacity: 0.9}}>
                                            Add Claude API key for intelligent workout parsing (understands blocks, rounds, exercises)
                                        </p>
                                    )}
                                    <input
                                        type="text"
                                        placeholder="sk-ant-api03-..."
                                        defaultValue={claudeApiKey}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            borderRadius: '6px',
                                            border: 'none',
                                            fontSize: '14px',
                                            marginBottom: '8px',
                                            boxSizing: 'border-box',
                                            background: '#FFFFFF',
                                            color: '#000000'
                                        }}
                                        onBlur={(e) => {
                                            if (e.target.value) {
                                                saveClaudeApiKey(e.target.value);
                                            }
                                        }}
                                    />
                                    <div style={{display: 'flex', gap: '8px'}}>
                                        {claudeApiKey && (
                                            <>
                                                <button
                                                    onClick={async () => {
                                                        try {
                                                            const response = await fetch('https://anthropic-proxy.peter-5aa.workers.dev/', {
                                                                method: 'POST',
                                                                headers: {
                                                                    'Content-Type': 'application/json',
                                                                    'x-api-key': claudeApiKey
                                                                },
                                                                body: JSON.stringify({
                                                                    model: 'claude-sonnet-4-20250514',
                                                                    max_tokens: 50,
                                                                    messages: [{role: 'user', content: 'Say "API key works!"'}]
                                                                })
                                                            });
                                                            const data = await response.json();
                                                            if (response.ok && data.content) {
                                                                alert('âœ“ API Key Works!\n\n' + data.content[0].text);
                                                            } else {
                                                                alert('âŒ API Key Error:\n\n' + (data.error?.message || JSON.stringify(data)));
                                                            }
                                                        } catch (error) {
                                                            alert('âŒ Connection Error:\n\n' + error.message);
                                                        }
                                                    }}
                                                    style={{
                                                        background: '#4A7C59',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        padding: '8px 12px',
                                                        color: 'white',
                                                        fontSize: '12px',
                                                        fontWeight: 600,
                                                        cursor: 'pointer',
                                                        flex: 1
                                                    }}
                                                >
                                                    Test Key
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        if (confirm('Clear Claude API key?')) {
                                                            localStorage.removeItem('anthropic-api-key');
                                                            setClaudeApiKey('');
                                                        }
                                                    }}
                                                    style={{
                                                        background: '#FF3B30',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        padding: '8px 12px',
                                                        color: 'white',
                                                        fontSize: '12px',
                                                        fontWeight: 600,
                                                        cursor: 'pointer',
                                                        flex: 1
                                                    }}
                                                >
                                                    Clear Key
                                                </button>
                                            </>
                                        )}
                                    </div>
                                    <p style={{fontSize: '11px', color: '#FFFFFF', opacity: 0.8, marginTop: '8px'}}>
                                        {claudeApiKey ? 'Tap "Test Key" to verify it works' : 'Get API key from console.anthropic.com'}
                                    </p>
                                </div>

                                <label className="upload-button">
                                    <span className="upload-icon">ðŸ“¸</span>
                                    <span style={{fontWeight: 600, color: '#FFFFFF'}}>Upload Today's Workout</span>
                                    <span style={{fontSize: '12px'}}>Tap to take photo or select from library</span>
                                    <input
                                        type="file"
                                        accept="image/*"
                                        className="file-input"
                                        onChange={handleImageUpload}
                                    />
                                </label>
                                <div style={{fontSize: '12px', color: '#7D7D7D', textAlign: 'center', marginTop: '-8px', marginBottom: '16px'}}>
                                    Look for Camera or Photos tabs at bottom of screen
                                </div>
                            </div>
                        ) : (
                            <div>
                                {/* API Key Input */}
                                {!apiKey && (
                                    <div style={{background: '#FF9500', padding: '16px', borderRadius: '12px', marginBottom: '20px'}}>
                                        <p style={{fontSize: '14px', fontWeight: 600, marginBottom: '8px', color: '#000'}}>
                                            ðŸ”‘ Setup Required
                                        </p>
                                        <p style={{fontSize: '12px', marginBottom: '12px', color: '#000'}}>
                                            Enter your Google Cloud Vision API key for automatic OCR
                                        </p>
                                        <input
                                            type="text"
                                            placeholder="Paste API key here"
                                            style={{
                                                width: '100%',
                                                padding: '10px',
                                                borderRadius: '6px',
                                                border: 'none',
                                                fontSize: '14px',
                                                marginBottom: '8px',
                                                boxSizing: 'border-box'
                                            }}
                                            onBlur={(e) => saveApiKey(e.target.value)}
                                        />
                                        <p style={{fontSize: '11px', color: '#000', opacity: 0.8}}>
                                            Your key is saved locally and never sent anywhere except Google's API
                                        </p>
                                    </div>
                                )}

                                {/* Image Display */}
                                <div style={{background: '#2A2A2A', padding: '20px', borderRadius: '12px', marginBottom: '20px'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px'}}>
                                        <p style={{color: '#4A7C59', fontSize: '14px', fontWeight: 600}}>âœ“ Image uploaded</p>
                                        {apiKey && !ocrProcessing && !ocrText && (
                                            <button
                                                onClick={() => processImageWithOCR(workoutImage)}
                                                style={{
                                                    background: 'linear-gradient(135deg, #2C5AA0 0%, #4A7C59 100%)',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    padding: '8px 16px',
                                                    color: 'white',
                                                    fontSize: '12px',
                                                    fontWeight: 600,
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                ðŸ” Read Text
                                            </button>
                                        )}
                                        {ocrProcessing && (
                                            <span style={{fontSize: '12px', color: '#7D7D7D'}}>â³ Processing...</span>
                                        )}
                                    </div>
                                    <img 
                                        src={workoutImage} 
                                        alt="Today's Workout" 
                                        style={{width: '100%', borderRadius: '8px', marginBottom: '12px'}}
                                    />
                                    <button 
                                        onClick={clearWorkoutImage}
                                        style={{
                                            width: '100%',
                                            background: '#FF3B30',
                                            border: 'none',
                                            borderRadius: '6px',
                                            padding: '10px',
                                            color: 'white',
                                            fontSize: '14px',
                                            fontWeight: 600,
                                            cursor: 'pointer'
                                        }}
                                    >
                                        ðŸ—‘ï¸ Remove Image
                                    </button>
                                </div>

                                {/* Editable Text Area */}
                                <div style={{background: '#2A2A2A', padding: '16px', borderRadius: '12px', marginBottom: '20px'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}>
                                        <label style={{fontSize: '14px', fontWeight: 600, color: '#FFFFFF'}}>
                                            ðŸ“ Exercises {ocrText && '(Detected Text)'}
                                        </label>
                                        {customWorkout && customWorkout.exercises && (
                                            <span style={{fontSize: '12px', color: '#4A7C59', fontWeight: 600}}>
                                                âœ“ {customWorkout.exercises.length} exercises parsed
                                            </span>
                                        )}
                                    </div>
                                    {claudeApiKey && ocrText && (
                                        <p style={{fontSize: '11px', color: '#4A7C59', marginBottom: '8px'}}>
                                            ðŸ¤– Claude AI parsing enabled
                                        </p>
                                    )}
                                    <p style={{fontSize: '12px', color: '#7D7D7D', marginBottom: '12px'}}>
                                        {ocrText ? 'Edit the detected text if needed' : 'Detected text will appear here'}
                                    </p>
                                    <textarea
                                        value={ocrText}
                                        style={{
                                            width: '100%',
                                            minHeight: '120px',
                                            background: '#1A1A1A',
                                            border: '1px solid #3A3A3A',
                                            borderRadius: '8px',
                                            padding: '12px',
                                            color: '#FFFFFF',
                                            fontSize: '14px',
                                            fontFamily: 'inherit',
                                            resize: 'vertical',
                                            boxSizing: 'border-box'
                                        }}
                                        placeholder="Raw OCR text will appear here..."
                                        onChange={(e) => {
                                            setOcrText(e.target.value);
                                            handleWorkoutTextChange(e.target.value);
                                        }}
                                    />
                                </div>
                            </div>
                        )}

                        <div className="card">
                            <div className="card-header">
                                <span className="card-icon">ðŸ’ª</span>
                                <div>
                                    <h2 className="card-title">{todayWorkout.name}</h2>
                                    <p className="card-subtitle">{dayName} â€¢ {todayWorkout.type}</p>
                                </div>
                            </div>

                            {todayWorkout.exercises.map((exercise, idx) => {
                                // Extract number of sets/rounds from target
                                // Check for time-based formats like "9-12MIN EMOM" or "12MIN EMOM"
                                let numSets = 1;
                                
                                // Try to find time range first (e.g., "9-12MIN" -> use 12)
                                const timeRangeMatch = exercise.target.match(/(\d+)-(\d+)\s*MIN/i);
                                if (timeRangeMatch) {
                                    numSets = parseInt(timeRangeMatch[2]); // Use the larger number
                                } else {
                                    // Try single time value (e.g., "12MIN")
                                    const singleTimeMatch = exercise.target.match(/(\d+)\s*MIN/i);
                                    if (singleTimeMatch) {
                                        numSets = parseInt(singleTimeMatch[1]);
                                    } else {
                                        // Fall back to traditional sets format (e.g., "3x10")
                                        const setsMatch = exercise.target.match(/(\d+)x/);
                                        numSets = setsMatch ? parseInt(setsMatch[1]) : 1;
                                    }
                                }
                                
                                return (
                                    <div key={idx} className="exercise-row">
                                        <div className="exercise-name">
                                            {exercise.name} - {exercise.target}
                                        </div>
                                        <div style={{marginTop: '12px'}}>
                                            {Array.from({length: numSets}, (_, setIdx) => (
                                                <div key={setIdx} style={{
                                                    display: 'grid',
                                                    gridTemplateColumns: 'auto 1fr 1fr',
                                                    gap: '8px',
                                                    alignItems: 'center',
                                                    marginBottom: '8px'
                                                }}>
                                                    <div style={{
                                                        fontSize: '12px',
                                                        color: '#7D7D7D',
                                                        fontWeight: 600,
                                                        minWidth: '60px'
                                                    }}>
                                                        Round {setIdx + 1}
                                                    </div>
                                                    <input
                                                        type="number"
                                                        className="exercise-input"
                                                        placeholder="Reps"
                                                        value={workoutData[`${idx}-${setIdx}-reps`] || ''}
                                                        onChange={(e) => setWorkoutData({
                                                            ...workoutData,
                                                            [`${idx}-${setIdx}-reps`]: e.target.value
                                                        })}
                                                    />
                                                    <input
                                                        type="number"
                                                        className="exercise-input"
                                                        placeholder="Weight"
                                                        value={workoutData[`${idx}-${setIdx}-weight`] || ''}
                                                        onChange={(e) => setWorkoutData({
                                                            ...workoutData,
                                                            [`${idx}-${setIdx}-weight`]: e.target.value
                                                        })}
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}

                            <div className="input-group" style={{marginTop: '16px'}}>
                                <label className="input-label">Training Notes</label>
                                <input
                                    type="text"
                                    className="input-field"
                                    placeholder="RPE, energy levels, observations..."
                                    value={workoutData['notes'] || ''}
                                    onChange={(e) => setWorkoutData({
                                        ...workoutData,
                                        notes: e.target.value
                                    })}
                                />
                            </div>

                            <button className="button-primary" onClick={saveWorkout}>
                                Save Workout
                            </button>

                            {savedMessage && (
                                <div className="success-banner" style={{marginTop: '16px'}}>
                                    {savedMessage}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const renderNutritionTab = () => (
                <div className="content">
                    {/* Meal Tracking Section */}
                    <div className="card">
                        <div className="card-header">
                            <span className="card-icon">ðŸ½ï¸</span>
                            <div>
                                <h2 className="card-title">Log a Meal</h2>
                                <p className="card-subtitle">Photo â†’ AI analyzes nutrition</p>
                            </div>
                        </div>

                        {!mealPhoto ? (
                            <label className="upload-button">
                                <span className="upload-icon">ðŸ“¸</span>
                                <span style={{fontWeight: 600, color: '#FFFFFF'}}>Take Meal Photo</span>
                                <span style={{fontSize: '12px'}}>AI will analyze macros and genetic fit</span>
                                <input
                                    type="file"
                                    accept="image/*"
                                    className="file-input"
                                    onChange={(e) => {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const reader = new FileReader();
                                            reader.onload = (ev) => {
                                                setMealPhoto(ev.target.result);
                                                analyseMeal(ev.target.result);
                                            };
                                            reader.readAsDataURL(file);
                                        }
                                    }}
                                />
                            </label>
                        ) : (
                            <div>
                                <img src={mealPhoto} alt="Meal" style={{width: '100%', borderRadius: '12px', marginBottom: '16px'}} />
                                {mealAnalysing ? (
                                    <div style={{textAlign: 'center', padding: '20px', color: '#7D7D7D'}}>
                                        <div style={{fontSize: '32px', marginBottom: '8px'}}>â³</div>
                                        <div>Analysing meal...</div>
                                    </div>
                                ) : currentMeal && (
                                    <div style={{background: '#2A2A2A', borderRadius: '12px', padding: '16px', marginBottom: '16px'}}>
                                        <h3 style={{fontSize: '16px', fontWeight: 700, marginBottom: '12px', color: '#4A7C59'}}>
                                            âœ“ {currentMeal.mealName}
                                        </h3>
                                        
                                        <div style={{marginBottom: '12px'}}>
                                            <div style={{fontSize: '12px', color: '#7D7D7D', marginBottom: '8px', fontWeight: 600}}>ESTIMATED MACROS</div>
                                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px'}}>
                                                <div style={{background: '#1A1A1A', padding: '8px', borderRadius: '6px', textAlign: 'center'}}>
                                                    <div style={{fontSize: '18px', fontWeight: 700, color: '#2C5AA0'}}>{currentMeal.estimatedMacros.protein}</div>
                                                    <div style={{fontSize: '11px', color: '#7D7D7D'}}>Protein</div>
                                                </div>
                                                <div style={{background: '#1A1A1A', padding: '8px', borderRadius: '6px', textAlign: 'center'}}>
                                                    <div style={{fontSize: '18px', fontWeight: 700, color: '#2C5AA0'}}>{currentMeal.estimatedMacros.carbs}</div>
                                                    <div style={{fontSize: '11px', color: '#7D7D7D'}}>Carbs</div>
                                                </div>
                                                <div style={{background: '#1A1A1A', padding: '8px', borderRadius: '6px', textAlign: 'center'}}>
                                                    <div style={{fontSize: '18px', fontWeight: 700, color: '#2C5AA0'}}>{currentMeal.estimatedMacros.fat}</div>
                                                    <div style={{fontSize: '11px', color: '#7D7D7D'}}>Fat</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div style={{fontSize: '13px', color: '#CCCCCC', marginBottom: '12px'}}>
                                            <div style={{fontWeight: 600, color: '#FFFFFF', marginBottom: '6px'}}>Genetic Alignment:</div>
                                            {currentMeal.geneticAlignment}
                                        </div>

                                        {recoveryScore && (
                                            <div style={{fontSize: '13px', color: '#CCCCCC', marginBottom: '12px'}}>
                                                <div style={{fontWeight: 600, color: '#FFFFFF', marginBottom: '6px'}}>Recovery Optimisation:</div>
                                                {currentMeal.recoveryOptimisation}
                                            </div>
                                        )}

                                        {currentMeal.improvements && (
                                            <div style={{fontSize: '13px', color: '#FF9500', marginBottom: '12px'}}>
                                                <div style={{fontWeight: 600, marginBottom: '6px'}}>ðŸ’¡ Suggestions:</div>
                                                {currentMeal.improvements}
                                            </div>
                                        )}
                                    </div>
                                )}
                                <button
                                    onClick={() => {
                                        setMealPhoto(null);
                                        setCurrentMeal(null);
                                    }}
                                    style={{
                                        width: '100%',
                                        background: '#FF3B30',
                                        border: 'none',
                                        borderRadius: '8px',
                                        padding: '12px',
                                        color: 'white',
                                        fontSize: '14px',
                                        fontWeight: 600,
                                        cursor: 'pointer'
                                    }}
                                >
                                    Clear & Log Another Meal
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Menu Recommendation Section */}
                    <div className="card">
                        <div className="card-header">
                            <span className="card-icon">ðŸ“‹</span>
                            <div>
                                <h2 className="card-title">Menu Analyzer</h2>
                                <p className="card-subtitle">Get personalized menu recommendations</p>
                            </div>
                        </div>

                        {!menuPhoto ? (
                            <label className="upload-button">
                                <span className="upload-icon">ðŸ“‹</span>
                                <span style={{fontWeight: 600, color: '#FFFFFF'}}>Upload Restaurant Menu</span>
                                <span style={{fontSize: '12px'}}>AI recommends best options for your genetics</span>
                                <input
                                    type="file"
                                    accept="image/*"
                                    className="file-input"
                                    onChange={(e) => {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const reader = new FileReader();
                                            reader.onload = (ev) => {
                                                setMenuPhoto(ev.target.result);
                                                analyseMenu(ev.target.result);
                                            };
                                            reader.readAsDataURL(file);
                                        }
                                    }}
                                />
                            </label>
                        ) : (
                            <div>
                                <img src={menuPhoto} alt="Menu" style={{width: '100%', borderRadius: '12px', marginBottom: '16px'}} />
                                {menuAnalysing ? (
                                    <div style={{textAlign: 'center', padding: '20px', color: '#7D7D7D'}}>
                                        <div style={{fontSize: '32px', marginBottom: '8px'}}>â³</div>
                                        <div>Analysing menu options...</div>
                                    </div>
                                ) : menuRecommendation && (
                                    <div style={{background: '#2A2A2A', borderRadius: '12px', padding: '16px', marginBottom: '16px'}}>
                                        <h3 style={{fontSize: '18px', fontWeight: 700, marginBottom: '12px', color: '#4A7C59'}}>
                                            ðŸŽ¯ Recommended: {menuRecommendation.recommendedDish}
                                        </h3>
                                        
                                        <div style={{fontSize: '14px', color: '#CCCCCC', marginBottom: '12px', lineHeight: 1.6}}>
                                            {menuRecommendation.reasoning}
                                        </div>

                                        <div style={{marginBottom: '12px'}}>
                                            <div style={{fontSize: '12px', color: '#7D7D7D', marginBottom: '8px', fontWeight: 600}}>ESTIMATED MACROS</div>
                                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px'}}>
                                                <div style={{background: '#1A1A1A', padding: '8px', borderRadius: '6px', textAlign: 'center'}}>
                                                    <div style={{fontSize: '16px', fontWeight: 700, color: '#4A7C59'}}>{menuRecommendation.macroEstimate.protein}</div>
                                                    <div style={{fontSize: '10px', color: '#7D7D7D'}}>Protein</div>
                                                </div>
                                                <div style={{background: '#1A1A1A', padding: '8px', borderRadius: '6px', textAlign: 'center'}}>
                                                    <div style={{fontSize: '16px', fontWeight: 700, color: '#4A7C59'}}>{menuRecommendation.macroEstimate.carbs}</div>
                                                    <div style={{fontSize: '10px', color: '#7D7D7D'}}>Carbs</div>
                                                </div>
                                                <div style={{background: '#1A1A1A', padding: '8px', borderRadius: '6px', textAlign: 'center'}}>
                                                    <div style={{fontSize: '16px', fontWeight: 700, color: '#4A7C59'}}>{menuRecommendation.macroEstimate.fat}</div>
                                                    <div style={{fontSize: '10px', color: '#7D7D7D'}}>Fat</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div style={{fontSize: '13px', color: '#CCCCCC', marginBottom: '12px'}}>
                                            <div style={{fontWeight: 600, color: '#FFFFFF', marginBottom: '6px'}}>ðŸ§¬ Genetic Benefits:</div>
                                            {menuRecommendation.geneticBenefits}
                                        </div>

                                        {menuRecommendation.modifications && (
                                            <div style={{fontSize: '13px', color: '#FF9500', marginBottom: '12px'}}>
                                                <div style={{fontWeight: 600, marginBottom: '6px'}}>âœï¸ Suggested Modifications:</div>
                                                {menuRecommendation.modifications}
                                            </div>
                                        )}

                                        {menuRecommendation.alternatives && (
                                            <div style={{fontSize: '13px', color: '#7D7D7D'}}>
                                                <div style={{fontWeight: 600, marginBottom: '6px'}}>Alternative:</div>
                                                {menuRecommendation.alternatives}
                                            </div>
                                        )}
                                    </div>
                                )}
                                <button
                                    onClick={() => {
                                        setMenuPhoto(null);
                                        setMenuRecommendation(null);
                                    }}
                                    style={{
                                        width: '100%',
                                        background: '#FF3B30',
                                        border: 'none',
                                        borderRadius: '8px',
                                        padding: '12px',
                                        color: 'white',
                                        fontSize: '14px',
                                        fontWeight: 600,
                                        cursor: 'pointer'
                                    }}
                                >
                                    Clear & Analyze Different Menu
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );

            );

            const renderChallengeTab = () => {
                const pushupTotal = challengeData.pushupSets.filter(s => s).length * 20;
                const pullupTotal = calculatePullupTotal();
                const stats = getChallengeStats();
                const currentMonth = new Date().toLocaleDateString('en-AU', { month: 'long' });

                return (
                    <div className="content">
                        <div className="card">
                            <div className="card-header">
                                <span className="card-icon">ðŸŽ¯</span>
                                <div>
                                    <h2 className="card-title">{currentMonth} Challenge</h2>
                                    <p className="card-subtitle">Daily targets: 100 pushups + 26 pullups</p>
                                </div>
                            </div>

                            {/* Today's Progress */}
                            <div className="challenge-progress">
                                <div className="progress-row">
                                    <span className="progress-label">Pushups</span>
                                    <span className={`progress-value ${pushupTotal >= 100 ? 'complete' : 'incomplete'}`}>
                                        {pushupTotal} / 100
                                    </span>
                                </div>
                                <div className="progress-row">
                                    <span className="progress-label">Pullups</span>
                                    <span className={`progress-value ${pullupTotal >= 26 ? 'complete' : 'incomplete'}`}>
                                        {pullupTotal} / 26
                                    </span>
                                </div>
                            </div>

                            {/* Pushup Sets */}
                            <div className="challenge-section">
                                <div className="challenge-title">
                                    ðŸ’ª Pushups
                                </div>
                                <div className="challenge-subtitle">
                                    Tap each set when complete (20 reps per set)
                                </div>
                                <div className="pushup-grid">
                                    {challengeData.pushupSets.map((completed, idx) => (
                                        <div
                                            key={idx}
                                            className={`pushup-set ${completed ? 'completed' : ''}`}
                                            onClick={() => togglePushupSet(idx)}
                                        >
                                            <div className="set-number">Set {idx + 1}</div>
                                            <div className="set-count">
                                                {completed ? 'âœ“' : '20'}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Pullup Sets */}
                            <div className="challenge-section">
                                <div className="challenge-title">
                                    ðŸ‹ï¸ Pullups
                                </div>
                                <div className="challenge-subtitle">
                                    Enter reps completed (up to 4 sets, total 26+)
                                </div>
                                <div className="pullup-grid">
                                    {challengeData.pullupSets.map((count, idx) => (
                                        <div key={idx} className="pullup-set">
                                            <div className="pullup-label">Set {idx + 1}</div>
                                            <input
                                                type="number"
                                                className="pullup-input"
                                                value={count}
                                                onChange={(e) => updatePullupSet(idx, e.target.value)}
                                                placeholder="0"
                                                min="0"
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <button className="button-primary" onClick={saveChallenge}>
                                Save Challenge
                            </button>

                            {challengeSaved && (
                                <div className="success-banner" style={{marginTop: '16px'}}>
                                    âœ“ Challenge saved!
                                </div>
                            )}
                        </div>

                        {/* Monthly Stats */}
                        <div className="card">
                            <div className="card-header">
                                <span className="card-icon">ðŸ“ˆ</span>
                                <div>
                                    <h2 className="card-title">{currentMonth} Stats</h2>
                                    <p className="card-subtitle">Month-to-date progress</p>
                                </div>
                            </div>

                            <div className="month-stats-grid">
                                <div className="stat-card">
                                    <div className="stat-value">{stats.daysCompleted}</div>
                                    <div className="stat-label">Perfect Days</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-value">{stats.totalDays}</div>
                                    <div className="stat-label">Total Days</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-value">{stats.totalPushups}</div>
                                    <div className="stat-label">Total Pushups</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-value">{stats.totalPullups}</div>
                                    <div className="stat-label">Total Pullups</div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="app-container">
                    <div className="header">
                        <h1>FNDTN PERFORMANCE</h1>
                        <div className="subtitle">Push Past Possible</div>
                        {recoveryScore !== null && (
                            <span className={`recovery-badge ${getRecoveryStatus(recoveryScore).color}`}>
                                {recoveryScore}% {getRecoveryStatus(recoveryScore).status}
                            </span>
                        )}
                    </div>

                    {activeTab === 'recovery' && renderRecoveryTab()}
                    {activeTab === 'supplements' && renderSupplementsTab()}
                    {activeTab === 'workout' && renderWorkoutTab()}
                    {activeTab === 'nutrition' && renderNutritionTab()}
                    {activeTab === 'challenge' && renderChallengeTab()}

                    <div className="tab-bar">
                        <button 
                            className={`tab-button ${activeTab === 'recovery' ? 'active' : ''}`}
                            onClick={() => setActiveTab('recovery')}
                        >
                            <span className="tab-icon">ðŸ“Š</span>
                            <span className="tab-label">Recovery</span>
                        </button>
                        <button 
                            className={`tab-button ${activeTab === 'supplements' ? 'active' : ''}`}
                            onClick={() => setActiveTab('supplements')}
                        >
                            <span className="tab-icon">ðŸ’Š</span>
                            <span className="tab-label">Supps</span>
                        </button>
                        <button 
                            className={`tab-button ${activeTab === 'workout' ? 'active' : ''}`}
                            onClick={() => setActiveTab('workout')}
                        >
                            <span className="tab-icon">ðŸ’ª</span>
                            <span className="tab-label">Workout</span>
                        </button>
                        <button 
                            className={`tab-button ${activeTab === 'nutrition' ? 'active' : ''}`}
                            onClick={() => setActiveTab('nutrition')}
                        >
                            <span className="tab-icon">ðŸ½ï¸</span>
                            <span className="tab-label">Nutrition</span>
                        </button>
                        <button 
                            className={`tab-button ${activeTab === 'challenge' ? 'active' : ''}`}
                            onClick={() => setActiveTab('challenge')}
                        >
                            <span className="tab-icon">ðŸŽ¯</span>
                            <span className="tab-label">Challenge</span>
                        </button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
